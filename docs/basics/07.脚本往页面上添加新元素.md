---
sidebar_position: 7
---

# è„šæœ¬å¾€é¡µé¢ä¸Šæ·»åŠ æ–°å…ƒç´ 

ä»‹ç»ä½¿ç”¨è„šæœ¬å¾€å‰ç«¯é¡µé¢æ’å…¥æŒ‰é’®æˆ–è€…ä¸€ä¸ªå°æ¡†æ¡†ä¹‹ç±»çš„å…ƒç´ .æœ€åå¼„ä¸€ä¸ªç»™ b ç«™çœŸÂ·ä¸€é”®ä¸‰è¿çš„æŒ‰é’®.

æœ‰å…´è¶£ä¹Ÿå¯ä»¥å†™äºŒè¿,å¤ªè€—ç¡¬å¸äº† T T

# è„šæœ¬å¾€é¡µé¢æ·»åŠ æ–°å…ƒç´ 

è„šæœ¬å¾€é¡µé¢å¢åŠ æ–°å…ƒç´ è¿™ç§éœ€æ±‚ç»å¸¸å¯è§,ä¾‹å¦‚ç™¾åº¦äº‘çš„è„šæœ¬,å°±ä¼šå¾€é¡µé¢ä¸Šæ·»åŠ ä¸€äº›è§£æé“¾æ¥ä¹‹ç±»çš„æŒ‰é’®,ä¸€äº›åŠ©æ‰‹ç±»å‹çš„ä¼šå¾€é¡µé¢ä¸Šæ·»åŠ ä¸€äº›å°çª—å£,æ˜¾ç¤ºè„šæœ¬çš„è¿è¡ŒçŠ¶æ€ç­‰ç­‰.

å¦‚æœè¦è®©è„šæœ¬å¾€é¡µé¢ä¸Šæ·»åŠ æ–°å…ƒç´ ,åŸç†å¾ˆç®€å•.

é¦–å…ˆä½¿ç”¨ `document.createElement`åˆ›å»ºå¥½ä½ æƒ³æ’å…¥çš„å…ƒç´ ,ä¾‹å¦‚æŒ‰é’®å°±` document.createElement("button")`,å¦‚æœä½ æœ‰å¾ˆå¤šç»„ä»¶æƒ³æ”¾è¿›å»çš„è¯å¯ä»¥ç”¨ `document.createElement("div")`,ç„¶åå¾€ element é‡Œçš„ innerHTML ç›´æ¥å†™ html ä»£ç .

ç„¶åæ‰¾åˆ°ä½ æƒ³æ’å…¥çš„ä½ç½®,ä½¿ç”¨ `append/insertBefore`ä¹‹ç±»çš„æ–¹æ³•æ’å…¥ä½ çš„ element.ä¹‹åå°±å¯ä»¥åœ¨ `F12 å¼€å‘è€…å·¥å…·`ä¸­çš„ `element`ä¸­çœ‹åˆ°æˆ‘ä»¬æ’å…¥çš„å†…å®¹äº†.

[append](https://developer.mozilla.org/zh-CN/docs/Web/API/ParentNode/append),[appendChild](https://developer.mozilla.org/zh-CN/docs/Web/API/Node/appendChild),[prepend](https://developer.mozilla.org/zh-CN/docs/Web/API/ParentNode/prepend),[insertBefore](https://developer.mozilla.org/zh-CN/docs/Web/API/Node/insertBefore),å…·ä½“æ–¹æ³•å’ŒåŒºåˆ«å¯ä»¥è‡ªè¡Œç™¾åº¦æœç´¢å’ŒæŸ¥çœ‹æ–‡æ¡£(å…¶å®æ˜¯æˆ‘å«Œéº»çƒ¦,æ•´ç†ä¸€ä¸‹åˆå¯ä»¥æ°´ä¸€ç¯‡äº†)

åƒä¸‹é¢çš„ä»£ç ,æ’å…¥åˆ°äº†æœ€åé¢

![1](./img/07/1.png)

å½“ç„¶ä¸Šè¿°æ˜¯çš„åŸç”Ÿçš„æ–¹æ³•,ä¾‹å¦‚æœ‰äº›ç½‘é¡µè‡ªå¸¦ jQuery,é‚£ä¹ˆå¯ä»¥ç”¨

```js
$("
    htmlä»£ç 
")
```

ä¹‹ç±»çš„æ–¹å¼å»åˆ›å»ºå…ƒç´ ,å†ç”¨ jQuery çš„`append`ä¹‹ç±»çš„æ–¹æ³•æ’å…¥åˆ°é¡µé¢ä¸­å».æœ¬ç³»åˆ—å†…å®¹è¿˜æ˜¯ä½¿ç”¨åŸç”Ÿçš„æ¥è¿›è¡Œè®²è§£å’Œä½¿ç”¨.

# æ–°å…ƒç´ çš„äº‹ä»¶ç›‘å¬

å…ƒç´ æ˜¯æ·»åŠ è¿›å»äº†,ä½†æ˜¯åªèƒ½çœ‹åˆä¸èƒ½ç”¨é‚£æœ‰å•¥ç”¨.æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç›‘å¬æˆ‘ä»¬çš„å…ƒç´ äº‹ä»¶,æœ€å¸¸ç”¨çš„å°±æ˜¯ click ç‚¹å‡»äº‹ä»¶,ç‚¹äº†æˆ‘ä»¬çš„æŒ‰é’®,è®©æˆ‘ä»¬çš„è„šæœ¬åšå‡ºä¸€äº›ååº”.

å¦‚æœæ˜¯ç±»ä¼¼æŒ‰é’®çš„æ–¹å¼,æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™.ç›´æ¥çš„ä½¿ç”¨ onclick çš„æ–¹æ³•.

```js
let btn = document.createElement("button");
btn.innerHTML =
  "æŒ‰é’®æ–‡å­—,å…¶å®ä¹Ÿå¯ä»¥å†™html,å˜æˆä¸‹é¢çš„æ ·å­(ä¸è¿‡è°ç”¨æŒ‰é’®æ¥åŒ…é‚£ä¹ˆå¤šhtmlæ ‡ç­¾å‘¢)"; //innerTextä¹Ÿå¯ä»¥,åŒºåˆ«æ˜¯innerTextä¸ä¼šè§£æhtml
btn.onclick = function () {
  //code
  alert("ç‚¹å‡»äº†æŒ‰é’®");
};
document.body.append(btn);
```

å¦‚æœæ˜¯ä¸€ä¸ª div,åœ¨é‡Œé¢å†™ html è‡ªç”±å‘æŒ¥,å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼.event è¯¦ç»†è¯´æ˜:[Event](https://developer.mozilla.org/zh-CN/docs/Web/API/Event)

```js
let div = document.createElement("div");
div.innerHTML =
  '<span id="span-1">span1</span><span class="sp">span class</span>';
div.onclick = function (event) {
  if (event.target.id == "span-1") {
    alert("span-1è¢«ç‚¹å‡»äº†");
  } else if (event.target.className == "sp") {
    alert("spè¿™ä¸€ç±»è¢«ç‚¹äº†");
  }
};
document.body.append(div);
```

è‡³äºä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„åŒºåˆ«,ç®€å•æ¥è¯´å°±æ˜¯å‰ä¸€ç§æ–¹æ³•æˆ‘ä»¬**ç›‘å¬çš„åªæœ‰ä¸€ä¸ªå…ƒç´ **,é‚£æˆ‘ä»¬è‚¯å®šå°±çŸ¥é“å°±åªå¯èƒ½æ˜¯è¿™ä¸€ä¸ªæ‰§è¡Œçš„æ“ä½œ.

åé¢çš„å› ä¸ºé‡Œé¢åŒ…å«äº†å¤šä¸ªå…ƒç´ ,æˆ‘ä»¬å°±å¯ä»¥ä» event é‡Œé¢æ‰¾åˆ°å®é™…è¢«ç‚¹å‡»çš„å…ƒç´ ,é€šè¿‡ id æˆ–è€… class å»åˆ¤æ–­,æ¥èµ°æˆ‘ä»¬çš„è„šæœ¬æ‰§è¡Œæµç¨‹.

å¦å¤–å†è¡¥å……ä¸€ä¸‹,ä¸Šé¢çš„ onclick å¯ä»¥æ”¹å†™æˆ addEventListener("click"),ç±»ä¼¼ä¸‹é¢è¿™æ ·.

```js
div.addEventListener("click", function (ev) {
  console.log(ev);
});
```

ä¸»è¦åŒºåˆ« onclick åªèƒ½ç»‘å®šä¸€ä¸ª function,addEventListener å¯ä»¥ç»‘å®šå¤šä¸ª,è¿™åˆæ¶‰åŠäº†å‰ç«¯çš„å†…å®¹,å¤§å®¶å¯ä»¥è¯¾åè¡¥ä¹ ä¸€ä¸‹,å¯ä»¥çœ‹ä¸€ä¸‹[addEventListener](https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener)çš„è¯´æ˜.ä¹Ÿè¿˜æœ‰å…¶å®ƒçš„ç»‘å®šäº‹ä»¶çš„æ–¹æ³•,è¿™é‡Œå°±ä¸ä¸€ä¸€åˆ—ä¸¾äº†.

å¯¹äºç›‘å¬é¡µé¢ä¸Šå·²ç»æœ‰çš„æŒ‰é’®,æ¨èç”¨ addEventListener,ä»¥é˜² onclick å°†åŸæ¥çš„æŒ‰é’®äº‹ä»¶è¦†ç›–æ‰(å¦‚æœæŒ‰é’®ä¹Ÿæ˜¯ç”¨ onclick çš„è¯),çœ‹æƒ…å†µè€Œå®š.

è€Œä¸”ä¹Ÿå¯ä»¥åœ¨äº‹ä»¶ä¸­ return false;ä½¿äº‹ä»¶ä¸å†å‘ä¸Šä¼ é€’.(æœ‰ç‚¹æ‰¯è¿œäº†,å°±éšå£æä¸€å¥ ğŸ˜‚,è¡¥å……ä¸€äº›è„šæœ¬çš„å¼€å‘å°æŠ€å·§,å°±åƒæ˜¯è¡¥å……å†…åŠ›ä¸€æ ·,ä»¥é˜²è¸©å‘,ä¸‡ä¸€é‡åˆ°äº†å‘¢,ä¸å¯èƒ½æ‰€æœ‰çš„ä¸œè¥¿éƒ½æ˜¯å®Œå…¨æŒ‰ç…§æ•™ç¨‹æ¥çš„.æœ‰å…´è¶£çš„å¯ä»¥è¯¾å¤–å»ç»†ç©¶,ä¹Ÿå¯ä»¥ç•¥è¿‡æœ‰ä¸ªå°è±¡å°±å¥½.)

## æ–°å…ƒç´ çš„ style

ä¸ºäº†å¥½çœ‹æˆ–è€…æ”¾åœ¨ç½‘é¡µä¸­ä¸çªå…€,æˆ‘ä»¬å¯ä»¥åŠ ä¸Šç½‘é¡µè‡ªå¸¦çš„ class æˆ–è€…è‡ªå·±å†™ä¸€äº›æ ·å¼,ç±»ä¼¼ä¸‹é¢è¿™æ ·:

```js
btn.className = "default-btn"; //æ·»åŠ class
btn.id = "submit-btn"; //æ·»åŠ id
btn.style.color = "#ff0000"; //ç»™æŒ‰é’®å†™styleæ ·å¼,æŸ¥çœ‹è¿™ä¸ªæ–‡æ¡£,çœ‹cssä¸JavaScriptçš„å¯¹åº”:https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Properties_Reference
div.innerHTML =
  '<span id="span-1" class="span-class" style="font-size:12px">span1</span><span class="sp" style="color:red">span class</span>'; //åœ¨htmlé‡Œå†™style
```

# bilibili çœŸÂ·ä¸€é”®ä¸‰è¿

ä¸Šé¢çš„å†…å®¹è¯´å®Œå,æ¥åšç‚¹å®é™…çš„ä¸œè¥¿,æœŸæœ›åœ¨é¡µé¢ä¸Šçš„æ”¶è—æŒ‰é’®å’Œåˆ†äº«æŒ‰é’®ä¸­é—´å¢åŠ ä¸€ä¸ªä¸‰è¿æŒ‰é’®

![](./img/07/2.png)

æˆ‘ä»¬å¯ä»¥å…ˆé€šè¿‡ `F12å¼€å‘è€…å·¥å…·`æ‰¾åˆ°è¿™ä¸€å—çš„å…ƒç´ ,å‘ç°æ˜¯ç”¨çš„ span,ä¸ºäº†æ ·å­ä¸€æ ·æˆ‘ä»¬å¯ä»¥ç”¨ span æ¥åˆ›å»º.ä¸è¿‡!ä¸ºäº†æ–¹ä¾¿,æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨ button,å¤§å®¶ä¹Ÿå¯ä»¥å½“ä½œè¯¾åä½œä¸šå»å®Œå–„.(å®é™…ä¸Šä¹Ÿæ²¡ä»€ä¹ˆå›¾æ ‡,ç›´æ¥ç”¨æŒ‰é’®å¾—äº†)

![](./img/07/3.png)

åˆ›å»ºä»£ç å¦‚ä¸‹:

```js
let triple = document.createElement("button");
triple.innerText = "ä¸‰è¿";
triple.style.background = "#757575"; //é¢œè‰²å¼„å¾—å·®ä¸å¤šå§
triple.style.color = "#fff";
triple.onclick = function () {
  //ä¸‰è¿ä»£ç 
};
```

æ’å…¥æˆ‘ä»¬å¯ä»¥æ‰¾åˆ° share çš„çˆ¶èŠ‚ç‚¹,ç„¶åä½¿ç”¨ insertBefore,åœ¨ share ä¹‹å‰æ’å…¥æˆ‘ä»¬çš„ä¸‰è¿æŒ‰é’®,ä»£ç å¦‚ä¸‹:

```js
let share = document.querySelector(".share");
share.parentElement.insertBefore(triple, share);
```

emmmm å¥½ä¸‘,å…ˆè¿™æ ·å§,åŠŸèƒ½æ˜¯å¯ä»¥çš„å°±è¡Œ ğŸ˜‚

![](./img/07/4.png)

ä¸è¿‡ç›´æ¥çš„è¿™æ ·æ’å…¥æ˜¯ä¸è¡Œçš„,æœ€ç»ˆä»£ç ç±»ä¼¼è¿™æ ·,æ¯”è¾ƒå¤æ‚éœ€è¦æœ‰ç‚¹ DOM ä¹‹ç±»çš„çŸ¥è¯†æ‰å¥½ç†è§£,æš‚æ—¶ä¸å±•å¼€å§,ä¹Ÿæš´åŠ›ä¸€ç‚¹ä¹Ÿå¯ä»¥ç›´æ¥ç”¨ setTimeout ç­‰ä¸€æ®µæ—¶é—´å†æ’å…¥,ä¸” run-at è®¾ç½®ä¸º document-end.

```js
let ops = document.querySelector("#arc_toolbar_report .ops");
//æ’å…¥ä¸‰è¿ä¹‹åå¥½åƒä¼šé‡æ–°ç”Ÿæˆ,ä¸æ·»åŠ å°±ä¸ä¼šé‡æ–°ç”Ÿæˆ,æš‚æ—¶æ²¡å¼„æ¸…ä»€ä¹ˆæƒ…å†µ,å…ˆè¿™æ ·å¤„ç†äº†.
//ä¸»è¦ä½œç”¨æ˜¯ç›‘å¬opsçš„DOMNodeInsertedäº‹ä»¶,ç­‰å®ƒä¿®æ”¹å®Œæˆä¹‹åå†æ’å…¥æˆ‘ä»¬çš„ä¸‰è¿æŒ‰é’®,å¦å¤–æ³¨æ„run-atæ˜¯document-end,è¦ç­‰å¾…opsç”Ÿæˆä¹‹åå†ç›‘å¬,ä¸ç„¶queryè¿”å›nullä¼šæŠ¥é”™
//è¿™ä¸ªäº‹ä»¶ä¼šå¤šæ¬¡è°ƒç”¨,ä½†æ˜¯æˆ‘ä»¬insertBeforeæ’å…¥å¦‚æœå…ƒç´ å­˜åœ¨,åªæ˜¯ä¿®æ”¹è€Œä¸ä¼šæ–°å¢
ops.addEventListener("DOMNodeInserted", function (event) {
  let share = document.querySelector(".share");
  share.parentElement.insertBefore(triple, share);
});
```

ç„¶åæˆ‘ä»¬å¯ä»¥é•¿æŒ‰å¤§æ‹‡æŒ‡,æŠ“ä¸€ä¸‹ä¸‰è¿çš„ http è¯·æ±‚,å°±åƒä¸Šä¸€èŠ‚çš„ ajax è‡ªåŠ¨å…³æ³¨ up ä¸»ä¸€æ ·

![](./img/07/5.png)

aid æ˜¯æˆ‘ä»¬çš„è§†é¢‘ id,csrf çš„åœ¨ cookie é‡Œé¢,è¿™é‡Œå°±æš‚æ—¶ä¸ç»†è¯´äº†,å› ä¸ºæˆ‘ä»¬å°±æ˜¯åœ¨ bilibili çš„é¡µé¢ä¸Š,æ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦ä½¿ç”¨ GM è·¨åŸŸ(æ‰€ä»¥æˆ‘çš„ grant æ˜¯ none,ä¸éœ€è¦æ²™ç›’ç¯å¢ƒ,å¦å¤–ç”¨ unsafeWindow ä¹ŸæŒºéº»çƒ¦çš„),è€Œä¸”ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ cookie å–åˆ° csrf,ç›´æ¥ç”¨ xhr è¯·æ±‚æ¥å£å°±è¡Œäº†.ä»£ç å¦‚ä¸‹:

```js
let httpRequest = new XMLHttpRequest();
httpRequest.open('POST', 'https://api.bilibili.com/x/web-interface/archive/like/triple');
httpRequest.setRequestHeader("Content-type","application/x-www-form-urlencoded");
httpRequest.withCredentials = true;//è®¾ç½®è·¨åŸŸå‘é€å¸¦ä¸Šcookie
let aid=window.__INITIAL_STATE__.aid;
let sKey="bili_jct";
let csrf=decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(sKey).replace(/[-.+*]/g, "\\$&amp;") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
//ä¸Šé¢è¿™ä¸€æ®µå°±æ˜¯å–å‡ºcsrf,åœ¨cookieé‡Œé¢æ˜¯bili_jct,è¿™ä¸€æ®µæˆ‘æ˜¯ç›´æ¥copyçš„,æ€»ä¹‹è·å–åˆ°å°±å¥½äº†å•¦
httpRequest.send('aid='+aid+'&amp;csrf='+csrf);
httpRequest.onreadystatechange = function () {
    if (httpRequest.readyState == 4 &amp;&amp; httpRequest.status == 200) {
        var json = JSON.parse(httpRequest.responseText);
        console.log(json);
        if(json.code==0){
           alert("ä¸‰è¿æˆåŠŸ!åˆ·æ–°é¡µé¢å¯è§");
        }else{
            alert("ä¸‰è¿å¤±è´¥/(ã„’oã„’)/~~");
        }
    }
};
```

ä¸Šè¿°å–csrfä»£ç æ¥è‡ª:[Document.cookie](https://developer.mozilla.org/zh-CN/docs/Web/API/Document/cookie%E4%B8%80%E4%B8%AA%E5%B0%8F%E6%A1%86%E6%9E%B6%EF%BC%9A%E4%B8%80%E4%B8%AA%E5%AE%8C%E6%95%B4%E6%94%AF%E6%8C%81unicode%E7%9As%84cookie%E8%AF%BB%E5%8F%96%E5%86%99%E5%85%A5%E5%99%A8)

# end

æˆ‘ä»¬è„šæœ¬æœ¬æ¬¡ç”¨äº† `run-at`,`grant none`,è¿™æ˜¯ä¹‹å‰å­¦ä¹ è¿‡çš„,å¤§å®¶å¯ä»¥å¤šå¤šæ³¨æ„ä¸€ä¸‹.

è„šæœ¬å®‰è£…åœ°å€

https://bbs.tampermonkey.net.cn/thread-238-1-1.html